<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>CorrigePen PRO â€“ Leitor ConfiÃ¡vel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white overflow-hidden">
    <div id="root"></div>

    <script type="module" type="text/babel">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const { useEffect, useRef, useState } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCZ77ugK5a3pw-U0NH43F2x1bu09sS5pJg",
            authDomain: "correcao-de-provas-f315d.firebaseapp.com",
            projectId: "correcao-de-provas-f315d",
            databaseURL: "https://correcao-de-provas-f315d-default-rtdb.firebaseio.com",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const CONFIG = { startX: 315, startY: 340, gapX: 84, gapY: 69, size: 28, threshold: 40000 };

        function App() {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [gabaritoReal, setGabaritoReal] = useState(null);
            const [scanAtual, setScanAtual] = useState([]);
            const [historico, setHistorico] = useState([]);
            const [isLocked, setIsLocked] = useState(false); // Estado para congelar a imagem

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const provaId = params.get("provaId");
                if (provaId) {
                    get(ref(db, `provas/${provaId}`)).then(s => {
                        if (s.exists()) setGabaritoReal(s.val().gabarito || s.val().respostas);
                    });
                }
                
                navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: 1280, height: 720 } 
                }).then(stream => videoRef.current.srcObject = stream);
            }, []);

            const executarOMR = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext("2d", { willReadFrequently: true });
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);

                const resultados = [];
                for (let q = 0; q < 10; q++) {
                    let marcada = null;
                    let maiorEscuro = 0;
                    let coordsEleita = null;

                    ['A','B','C'].forEach((opt, i) => {
                        const x = CONFIG.startX + i * CONFIG.gapX;
                        const y = CONFIG.startY + q * CONFIG.gapY;
                        const pixels = ctx.getImageData(x, y, CONFIG.size, CONFIG.size).data;
                        let escuro = 0;
                        for (let p = 0; p < pixels.length; p += 4) {
                            escuro += 255 - (pixels[p] + pixels[p+1] + pixels[p+2]) / 3;
                        }

                        if (escuro > CONFIG.threshold && escuro > maiorEscuro) {
                            maiorEscuro = escuro;
                            marcada = opt;
                            coordsEleita = { x, y };
                        }
                    });

                    // Feedback Visual de Certeza: Desenha um cÃ­rculo verde sÃ³lido na opÃ§Ã£o escolhida
                    if (marcada && coordsEleita) {
                        ctx.fillStyle = "rgba(0, 255, 0, 0.5)";
                        ctx.beginPath();
                        ctx.arc(coordsEleita.x + CONFIG.size/2, coordsEleita.y + CONFIG.size/2, CONFIG.size, 0, Math.PI*2);
                        ctx.fill();
                        ctx.strokeStyle = "#00FF00";
                        ctx.lineWidth = 4;
                        ctx.stroke();
                    }
                    resultados.push(marcada);
                }
                setScanAtual(resultados);
            };

            // Loop de preview (roda apenas se nÃ£o estiver travado)
            useEffect(() => {
                const interval = setInterval(() => {
                    if (!isLocked) executarOMR();
                }, 150);
                return () => clearInterval(interval);
            }, [isLocked]);

            const bip = (f) => {
                const audio = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audio.createOscillator();
                const g = audio.createGain();
                osc.connect(g); g.connect(audio.destination);
                osc.frequency.value = f; g.gain.value = 0.1;
                osc.start(); osc.stop(audio.currentTime + 0.1);
            };

            const salvar = () => {
                if (!gabaritoReal) return alert("Aguardando gabarito do Firebase...");
                const acertos = scanAtual.reduce((acc, r, i) => r === gabaritoReal[i] ? acc + 1 : acc, 0);
                setHistorico([{ id: Date.now(), acertos, nota: (acertos / gabaritoReal.length * 10).toFixed(1) }, ...historico]);
                setIsLocked(false);
                bip(880);
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    {/* CAMERA AREA */}
                    <div className="relative flex-1 bg-black">
                        <video ref={videoRef} autoPlay playsInline className={`w-full h-full object-cover ${isLocked ? 'opacity-40' : ''}`} />
                        <canvas ref={canvasRef} className="absolute top-0 left-0 w-full h-full object-cover" />
                        
                        {/* Guia Lateral de Leitura */}
                        {isLocked && (
                            <div className="absolute right-4 top-10 bg-black/80 border border-green-500 p-3 rounded-xl font-mono text-xs">
                                <h3 className="text-green-400 font-bold mb-2 underline text-center">LIDO:</h3>
                                {scanAtual.map((r, i) => (
                                    <div key={i} className="flex justify-between w-20 border-b border-white/10 py-1">
                                        <span className="text-gray-500">{i+1}:</span>
                                        <span className={r ? "text-white font-bold" : "text-red-500"}>{r || "?"}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* FOOTER CONTROLS */}
                    <div className="bg-slate-900 border-t border-slate-700 p-4 pb-8 shadow-2xl">
                        {!isLocked ? (
                            <button onClick={() => { setIsLocked(true); bip(440); }} className="w-full bg-blue-600 py-6 rounded-2xl text-xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-all">
                                ðŸ“· Capturar Prova
                            </button>
                        ) : (
                            <div className="flex gap-4">
                                <button onClick={() => setIsLocked(false)} className="flex-1 bg-slate-700 py-6 rounded-2xl font-bold uppercase text-sm">Voltar</button>
                                <button onClick={salvar} className="flex-[2] bg-green-600 py-6 rounded-2xl text-xl font-black uppercase shadow-lg shadow-green-900/20">Confirmar Nota</button>
                            </div>
                        )}
                        <div className="flex gap-2 mt-4 overflow-x-auto h-12">
                            {historico.map(h => (
                                <div key={h.id} className="bg-slate-800 px-3 py-1 rounded border-b-2 border-green-500 min-w-[60px] text-center">
                                    <span className="text-[10px] block text-gray-500 leading-none">NOTA</span>
                                    <span className="text-lg font-bold text-green-400">{h.nota}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
</body>
</html>
