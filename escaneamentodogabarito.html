<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>CorrigePen – Leitor de Gabarito</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-white">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useRef, useState } = React;

    /* ================= CONFIGURAÇÃO OMR ================= */
    const CONFIG = {
      startX: 315,
      startY: 340,
      gapX: 84,
      gapY: 69,
      size: 25,
      threshold: 38000
    };

    const GABARITO = ['A','B','C','A','B','C','A','B','C','A'];

    /* ================= APP ================= */
    function App() {
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const scanFn = useRef(null);

      const [scanAtual, setScanAtual] = useState([]);
      const [historico, setHistorico] = useState([]);

      /* ===== CAMERA ===== */
      useEffect(() => {
        navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: 1280, height: 720 }
        }).then(stream => {
          videoRef.current.srcObject = stream;
        });
      }, []);

      /* ===== SCANNER ===== */
      scanFn.current = () => {
        const video = videoRef.current;
        const canvas = canvasRef.current;
        if (!video || !canvas || video.videoWidth === 0) return;

        const ctx = canvas.getContext("2d", { willReadFrequently: true });

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video, 0, 0);

        const respostas = [];

        for (let q = 0; q < 10; q++) {
          let marcada = null;
          let maiorEscuro = 0;

          ['A','B','C'].forEach((opt, i) => {
            const x = CONFIG.startX + i * CONFIG.gapX;
            const y = CONFIG.startY + q * CONFIG.gapY;

            const img = ctx.getImageData(x, y, CONFIG.size, CONFIG.size).data;
            let escuro = 0;

            for (let p = 0; p < img.length; p += 4) {
              escuro += 255 - (img[p] + img[p+1] + img[p+2]) / 3;
            }

            if (escuro > CONFIG.threshold && escuro > maiorEscuro) {
              maiorEscuro = escuro;
              marcada = opt;
            }

            ctx.strokeStyle = escuro > CONFIG.threshold ? "#00ff00" : "#ff0000";
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, CONFIG.size, CONFIG.size);
          });

          respostas.push(marcada);
        }

        setScanAtual(respostas);
      };

      /* ===== LOOP ===== */
      useEffect(() => {
        const timer = setInterval(() => {
          scanFn.current();
        }, 180);
        return () => clearInterval(timer);
      }, []);

      /* ===== SALVAR ===== */
      const salvar = () => {
        const acertos = scanAtual.reduce(
          (acc, r, i) => r === GABARITO[i] ? acc + 1 : acc,
          0
        );

        setHistorico([
          {
            id: Date.now(),
            acertos,
            nota: ((acertos / GABARITO.length) * 10).toFixed(1),
            hora: new Date().toLocaleTimeString()
          },
          ...historico
        ]);
      };

      /* ================= UI ================= */
      return (
        <div className="flex flex-col lg:flex-row h-screen">

          {/* CAMERA */}
          <div className="relative flex-[2] bg-black">
            <video
              ref={videoRef}
              autoPlay
              playsInline
              className="w-full h-full"
            />
            <canvas
              ref={canvasRef}
              className="absolute top-0 left-0 pointer-events-none opacity-70"
            />
            <div className="absolute top-3 left-3 bg-black/60 px-3 py-1 rounded text-xs">
              Scanner ativo – 10 questões (ABC)
            </div>
          </div>

          {/* RESULTADOS */}
          <div className="flex-1 bg-slate-800 p-6 overflow-y-auto border-l border-slate-700">
            <h2 className="text-xl font-bold mb-4">Resultados</h2>

            <button
              onClick={salvar}
              className="w-full bg-green-600 hover:bg-green-500 py-4 rounded-xl font-bold mb-6"
            >
              CONFIRMAR E SALVAR NOTA
            </button>

            {historico.length === 0 && (
              <p className="text-slate-400 text-center">
                Nenhuma leitura salva ainda
              </p>
            )}

            <div className="space-y-3">
              {historico.map(item => (
                <div
                  key={item.id}
                  className="bg-slate-700 p-3 rounded-lg flex justify-between items-center border-l-4 border-green-500"
                >
                  <div>
                    <p className="text-xs text-slate-400">{item.hora}</p>
                    <p className="font-bold">{item.acertos} acertos</p>
                  </div>
                  <div className="text-2xl font-black text-green-400">
                    {item.nota}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
