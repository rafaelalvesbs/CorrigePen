<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Gabarito - Scanner</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* CSS ORIGINAL MANTIDO */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #000; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        #scanner-container { position: relative; flex: 1; display: flex; justify-content: center; align-items: center; background: #1a1a1a; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; border: 40px solid rgba(0,0,0,0.6); pointer-events: none; display: flex; justify-content: center; align-items: center; }
        .guide-box { width: 80%; height: 70%; border: 2px solid #27ae60; border-radius: 10px; position: relative; box-shadow: 0 0 20px rgba(39, 174, 96, 0.4); }
        .corner { position: absolute; width: 20px; height: 20px; border: 4px solid #fff; }
        .top-left { top: -5px; left: -5px; border-right: 0; border-bottom: 0; }
        .top-right { top: -5px; right: -5px; border-left: 0; border-bottom: 0; }
        .bottom-left { bottom: -5px; left: -5px; border-right: 0; border-top: 0; }
        .bottom-right { bottom: -5px; right: -5px; border-left: 0; border-top: 0; }
        .controls { height: 150px; background: #003058; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; border-top-left-radius: 20px; border-top-right-radius: 20px; }
        .btn-capture { width: 70px; height: 70px; border-radius: 50%; background: #fff; border: 5px solid #27ae60; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: #27ae60; transition: 0.3s; }
        .btn-capture:active { transform: scale(0.9); }
        .status-text { margin-top: 10px; font-size: 0.9rem; color: #2ecc71; font-weight: bold; }
        #result-preview { position: absolute; bottom: 160px; left: 20px; right: 20px; background: rgba(255,255,255,0.9); color: #333; padding: 15px; border-radius: 10px; display: none; animation: slideUp 0.3s ease; z-index: 10; }
        @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Debug canvas para ver as coordenadas (opcional) */
        #debug-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0.5; }
    </style>
</head>
<body>

<div id="scanner-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="debug-canvas"></canvas>
    
    <div class="overlay">
        <div class="guide-box">
            <div class="corner top-left"></div>
            <div class="corner top-right"></div>
            <div class="corner bottom-left"></div>
            <div class="corner bottom-right"></div>
        </div>
    </div>

    <div id="result-preview">
        <strong>Resultado Detectado:</strong>
        <p id="stats">Processando...</p>
    </div>
</div>

<div class="controls">
    <button class="btn-capture" id="capture">
        <i class="fa-solid fa-camera"></i>
    </button>
    <div class="status-text" id="status">POSICIONE A FOLHA NA MOLDURA</div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const captureBtn = document.getElementById('capture');
    const statusText = document.getElementById('status');
    const resultPreview = document.getElementById('result-preview');
    const statsP = document.getElementById('stats');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // COORDENADAS FORNECIDAS
    const startX = 377;
    const startY = 351;
    const gapX = 93;
    const gapY = 76;
    const numQuestoes = 10;
    const alternativas = ['A', 'B', 'C'];

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } },
                audio: false
            });
            video.srcObject = stream;
        } catch (err) {
            statusText.innerText = "ERRO AO ACESSAR CÂMERA";
        }
    }

    // Função que "lê" os pixels nas coordenadas
    function processarGabarito() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        let resultados = [];
        
        for (let i = 0; i < numQuestoes; i++) {
            let questaoMarcada = "?";
            let maiorEscuridao = 0;

            alternativas.forEach((alt, indexAlt) => {
                const posX = startX + (indexAlt * gapX);
                const posY = startY + (i * gapY);

                // Analisa área de 20x20 pixels ao redor da coordenada
                const imageData = ctx.getImageData(posX - 10, posY - 10, 20, 20);
                let escuridao = 0;

                for (let p = 0; p < imageData.data.length; p += 4) {
                    // Soma quão escuro é o pixel (Luminosidade invertida)
                    escuridao += (255 - (imageData.data[p] + imageData.data[p+1] + imageData.data[p+2]) / 3);
                }

                if (escuridao > maiorEscuridao && escuridao > 5000) { // Threshold de segurança
                    maiorEscuridao = escuridao;
                    questaoMarcada = alt;
                }
            });
            resultados.push(`Q${i+1}:${questaoMarcada}`);
        }
        return resultados;
    }

    captureBtn.addEventListener('click', () => {
        if (video.readyState !== 4) return;

        statusText.innerText = "LENDO COORDENADAS...";
        captureBtn.style.background = "#27ae60";
        captureBtn.style.color = "#fff";

        setTimeout(() => {
            const leituras = processarGabarito();
            const acertos = leituras.filter(r => !r.includes('?')).length;
            
            statusText.innerText = "LEITURA CONCLUÍDA!";
            statsP.innerHTML = `<strong>Captura:</strong> ${leituras.join(' | ')}<br><strong>Total Identificado:</strong> ${acertos}/10 questões`;
            resultPreview.style.display = "block";
            
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            oscillator.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1);

            setTimeout(() => {
                resultPreview.style.display = "none";
                statusText.innerText = "POSICIONE A PRÓXIMA FOLHA";
                captureBtn.style.background = "#fff";
                captureBtn.style.color = "#27ae60";
            }, 5000);

        }, 500);
    });

    window.onload = startCamera;
</script>

</body>
</html>
