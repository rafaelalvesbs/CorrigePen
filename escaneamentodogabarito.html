<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor OMR de Precisão</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { margin: 0; background: #111; color: white; font-family: sans-serif; text-align: center; overflow: hidden; }
    .camera-container { position: relative; display: inline-block; width: 100%; max-width: 500px; }
    video, #overlay { position: absolute; top: 0; left: 0; width: 100%; height: auto; }
    canvas { display: none; } /* Canvas oculto, usado só para processar */
    #ui { margin-top: 100%; position: relative; z-index: 10; padding-top: 20px; }
    button { padding: 15px 40px; font-size: 18px; border-radius: 50px; background: #00ff00; border: none; font-weight: bold; cursor: pointer; }
    .instrucao { font-size: 14px; color: #aaa; margin-bottom: 10px; }
</style>
</head>
<body>

<h2>Escaneie o Gabarito</h2>
<p class="instrucao">Encaixe as bolinhas nos quadrados verdes</p>

<div class="camera-container" id="scanner-area">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
</div>

<div id="ui">
    <button onclick="capturar()">CAPTURAR</button>
</div>

<canvas id="canvas"></canvas>
<audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const canvas = document.getElementById("canvas");
const octx = overlay.getContext("2d");
const ctx = canvas.getContext("2d");
const beep = document.getElementById("beep");

// CONFIGURAÇÃO (Ajuste aqui para bater com seu papel impresso)
const QUESTOES = 10;
const ALTERNATIVAS = ["A", "B", "C"];
const baseX = [0.35, 0.50, 0.65]; // Colunas A, B e C
const baseY = 0.25;              // Onde começa a Q1
const gapY = 0.06;               // Espaço entre linhas
const boxSize = 20;              // Tamanho da área de leitura

navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment", width: { ideal: 1280 } }
}).then(stream => {
    video.srcObject = stream;
    requestAnimationFrame(desenharGuia);
});

// Desenha os quadradinhos na tela EM TEMPO REAL
function desenharGuia() {
    overlay.width = video.clientWidth;
    overlay.height = video.clientHeight;
    
    octx.clearRect(0, 0, overlay.width, overlay.height);
    octx.strokeStyle = "rgba(0, 255, 0, 0.5)";
    octx.lineWidth = 2;

    for (let q = 0; q < QUESTOES; q++) {
        for (let a = 0; a < 3; a++) {
            const x = overlay.width * baseX[a];
            const y = overlay.height * (baseY + q * gapY);
            octx.strokeRect(x - boxSize/2, y - boxSize/2, boxSize, boxSize);
            
            if (a === 0) { // Desenha o número da questão ao lado
                octx.fillStyle = "white";
                octx.font = "12px Arial";
                octx.fillText(q + 1, x - 30, y + 5);
            }
        }
    }
    requestAnimationFrame(desenharGuia);
}

function capturar() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    analisar();
}

function analisar() {
    const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = img.data;
    let respostas = [];

    for (let q = 0; q < QUESTOES; q++) {
        let marcadas = [];
        for (let a = 0; a < 3; a++) {
            const x = Math.floor(canvas.width * baseX[a] - boxSize/2);
            const y = Math.floor(canvas.height * (baseY + q * gapY) - boxSize/2);

            let pretos = 0;
            for (let dy = 0; dy < boxSize; dy++) {
                for (let dx = 0; dx < boxSize; dx++) {
                    const px = ((y + dy) * canvas.width + (x + dx)) * 4;
                    const brightness = (data[px] + data[px+1] + data[px+2]) / 3;
                    if (brightness < 100) pretos++; // Ajustado para ser mais sensível ao preto
                }
            }
            // Se mais de 25% do quadradinho estiver preto, considera marcado
            if (pretos > (boxSize * boxSize) * 0.25) {
                marcadas.push(ALTERNATIVAS[a]);
            }
        }
        respostas.push(marcadas.length === 1 ? marcadas[0] : (marcadas.length > 1 ? "ANULADA" : "BRANCO"));
    }

    beep.play();
    alert("RESULTADO:\n\n" + respostas.map((r,i)=>`Q${i+1}: ${r}`).join("\n"));
}
</script>
</body>
</html>
