<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Integrado Firebase</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white overflow-hidden">
    <div id="root"></div>

    <script type="module" type="text/babel">
        // IMPORTAÇÕES DO FIREBASE (Igual ao seu arquivo de QR Code)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCZ77ugK5a3pw-U0NH43F2x1bu09sS5pJg",
            authDomain: "correcao-de-provas-f315d.firebaseapp.com",
            projectId: "correcao-de-provas-f315d",
            databaseURL: "https://correcao-de-provas-f315d-default-rtdb.firebaseio.com",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const { useState, useRef, useEffect } = React;

        // SUAS COORDENADAS CALIBRADAS
        const CONFIG = {
            startX: 315, startY: 340, gapX: 84, gapY: 69,
            size: 25, threshold: 40000
        };

        function ScannerApp() {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [gabaritoOficial, setGabaritoOficial] = useState(null);
            const [alunoNotas, setAlunoNotas] = useState([]);
            const [currentScan, setCurrentScan] = useState(null);
            const [isLocked, setIsLocked] = useState(false);
            const [loading, setLoading] = useState(true);

            // 1. BUSCAR GABARITO NO FIREBASE AO INICIAR
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const provaId = params.get("provaId");

                if (!provaId) {
                    alert("Erro: ID da prova não encontrado na URL.");
                    return;
                }

                async function buscarGabarito() {
                    try {
                        const snapshot = await get(ref(db, `provas/${provaId}`));
                        if (snapshot.exists()) {
                            const dados = snapshot.val();
                            // SUPOSIÇÃO: O campo no Firebase se chama 'gabarito' e é um array ['A', 'B'...]
                            // Se o nome for diferente no seu banco, ajuste a linha abaixo:
                            setGabaritoOficial(dados.gabarito || dados.respostas);
                        } else {
                            alert("Prova não encontrada no banco de dados.");
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                }
                buscarGabarito();
            }, []);

            // 2. INICIAR CÂMERA
            useEffect(() => {
                if (!loading) {
                    navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "environment", width: 1280, height: 720 } 
                    }).then(stream => videoRef.current.srcObject = stream);
                    
                    const timer = setInterval(() => {
                        if (!isLocked) scannerLogic();
                    }, 100);
                    return () => clearInterval(timer);
                }
            }, [isLocked, loading]);

            const playBeep = (freq = 440, duration = 0.1) => {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = freq;
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + duration);
            };

            const scannerLogic = () => {
                if (!videoRef.current || !canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d', { willReadFrequently: true });
                canvasRef.current.width = videoRef.current.videoWidth;
                canvasRef.current.height = videoRef.current.videoHeight;
                ctx.drawImage(videoRef.current, 0, 0);

                const detected = [];
                for (let q = 0; q < 10; q++) {
                    let marked = null;
                    let maxDark = 0;
                    ['A', 'B', 'C'].forEach((opt, i) => {
                        const x = CONFIG.startX + (i * CONFIG.gapX);
                        const y = CONFIG.startY + (q * CONFIG.gapY);
                        const data = ctx.getImageData(x, y, CONFIG.size, CONFIG.size).data;
                        let dark = 0;
                        for (let p = 0; p < data.length; p += 4) {
                            dark += (255 - (data[p] + data[p+1] + data[p+2]) / 3);
                        }
                        if (dark > CONFIG.threshold && dark > maxDark) {
                            maxDark = dark;
                            marked = opt;
                        }
                        ctx.strokeStyle = dark > CONFIG.threshold ? "#00ff00" : "rgba(255,255,255,0.2)";
                        ctx.lineWidth = 3;
                        ctx.strokeRect(x, y, CONFIG.size, CONFIG.size);
                    });
                    detected.push(marked);
                }
                setCurrentScan(detected);
            };

            const handleConfirm = () => {
                if (!gabaritoOficial) return alert("Gabarito oficial não carregado!");

                const acertos = currentScan.reduce((acc, res, i) => 
                    res === gabaritoOficial[i] ? acc + 1 : acc, 0);
                
                const novaNota = {
                    id: alunoNotas.length + 1,
                    acertos,
                    nota: (acertos / gabaritoOficial.length * 10).toFixed(1),
                    hora: new Date().toLocaleTimeString()
                };

                setAlunoNotas([novaNota, ...alunoNotas]);
                setIsLocked(false);
                playBeep(880, 0.1);
            };

            if (loading) return <div class="h-screen flex items-center justify-center">Carregando Gabarito...</div>;

            return (
                <div class="flex flex-col h-screen">
                    <div class="relative flex-1 bg-black overflow-hidden">
                        <video ref={videoRef} autoPlay playsInline class={`w-full h-full object-cover ${isLocked ? 'opacity-40' : ''}`} />
                        <canvas ref={canvasRef} class="absolute top-0 left-0 w-full h-full object-cover" />
                        <div class="absolute top-4 right-4 bg-blue-600 px-3 py-1 rounded text-xs font-bold">
                            Gabarito Carregado ✓
                        </div>
                    </div>

                    <div class="h-24 bg-slate-900 flex items-center px-4 gap-4 overflow-x-auto border-t border-slate-800">
                        {alunoNotas.map(n => (
                            <div key={n.id} class="bg-slate-800 border-b-2 border-green-500 p-2 min-w-[80px] text-center">
                                <p class="text-[9px] text-gray-400">ALUNO {n.id}</p>
                                <p class="text-lg font-black text-green-400">{n.nota}</p>
                            </div>
                        ))}
                    </div>

                    <div class="bg-slate-900 p-4 pb-8 flex gap-4 shadow-2xl">
                        {!isLocked ? (
                            <button onClick={() => { setIsLocked(true); playBeep(600, 0.05); }} class="flex-1 bg-blue-600 py-5 rounded-2xl font-black text-xl uppercase tracking-tighter">
                                Capturar Respostas
                            </button>
                        ) : (
                            <>
                                <button onClick={() => setIsLocked(false)} class="flex-1 bg-slate-700 py-5 rounded-2xl font-bold uppercase">Voltar</button>
                                <button onClick={handleConfirm} class="flex-[2] bg-green-600 py-5 rounded-2xl font-black text-xl uppercase">Confirmar Nota</button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ScannerApp />);
    </script>
</body>
</html>
