<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner OMR Pro</title>
    <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #000; color: white; overflow: hidden; }
        .container { position: relative; width: 100vw; height: 100vh; }
        #video-feed { width: 100%; height: 100%; object-fit: cover; }
        #canvas-output { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        
        .guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 75%; height: 55%; border: 3px solid #00ff00;
            border-radius: 15px; pointer-events: none; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
        }

        .status-panel {
            position: absolute; top: 30px; width: 100%; text-align: center;
            background: rgba(0,0,0,0.8); padding: 20px; z-index: 10;
        }

        #loading-cv {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #998675; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }

        .btn-scan {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            padding: 20px 50px; background: #00ff00; border: none;
            color: #000; border-radius: 40px; font-weight: 900; font-size: 20px;
            box-shadow: 0 0 20px rgba(0,255,0,0.5); display: none; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="loading-cv">
    <p>Carregando Inteligência Visual...</p>
</div>

<div class="container">
    <video id="video-feed" autoplay playsinline></video>
    <canvas id="canvas-output"></canvas>
    <div class="guide"></div>

    <div class="status-panel">
        <h2 id="info">Buscando Gabarito...</h2>
        <p id="sub-info">Aproxime a câmera das bolinhas</p>
    </div>

    <button id="btn-processar" class="btn-scan">CAPTURAR AGORA</button>
</div>

<audio id="beep-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script type="text/javascript">
    const video = document.getElementById('video-feed');
    const canvas = document.getElementById('canvas-output');
    const btn = document.getElementById('btn-processar');
    const beep = document.getElementById('beep-sound');
    const info = document.getElementById('info');
    
    let provaId = new URLSearchParams(window.location.search).get("provaId");

    function checkOpenCV() {
        if (typeof cv !== 'undefined' && cv.Mat) {
            document.getElementById('loading-cv').style.display = 'none';
            startCamera();
        } else {
            setTimeout(checkOpenCV, 500);
        }
    }
    checkOpenCV();

    async function startCamera() {
        const constraints = {
            video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        video.onloadedmetadata = () => processFrame();
    }

    function processFrame() {
        let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        let gray = new cv.Mat();
        let cap = new cv.VideoCapture(video);

        function loop() {
            try {
                cap.read(src);
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // --- MELHORIA DE CONTRASTE ---
                // Aplica um Threshold adaptativo para destacar as bolinhas pretas no papel branco
                cv.adaptiveThreshold(gray, gray, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 11, 2);
                
                let circles = new cv.Mat();
                // Parâmetros ajustados para maior sensibilidade
                cv.HoughCircles(gray, circles, cv.HOUGH_GRADIENT, 1, 40, 50, 20, 15, 40);

                const ctx = canvas.getContext('2d');
                canvas.width = video.clientWidth;
                canvas.height = video.clientHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (circles.cols > 0) {
                    if (btn.style.display !== 'block') {
                        beep.play(); // Som positivo ao encontrar
                        btn.style.display = 'block';
                    }
                    info.innerText = "BOLINHAS IDENTIFICADAS";
                    info.style.color = "#00ff00";

                    for (let i = 0; i < Math.min(circles.cols, 25); ++i) {
                        let x = circles.data32F[i * 3];
                        let y = circles.data32F[i * 3 + 1];
                        let r = circles.data32F[i * 3 + 2];

                        let scaleX = canvas.width / video.videoWidth;
                        let scaleY = canvas.height / video.videoHeight;

                        ctx.beginPath();
                        ctx.arc(x * scaleX, y * scaleY, r * scaleX, 0, 2 * Math.PI);
                        ctx.fillStyle = "rgba(0, 255, 0, 0.7)";
                        ctx.fill();
                        ctx.strokeStyle = "#fff";
                        ctx.lineWidth = 3;
                        ctx.stroke();
                    }
                } else {
                    btn.style.display = 'none';
                    info.innerText = "BUSCANDO MARCAÇÕES...";
                    info.style.color = "#fff";
                }
                
                circles.delete();
                requestAnimationFrame(loop);
            } catch (e) {
                requestAnimationFrame(loop);
            }
        }
        loop();
    }

    btn.onclick = () => {
        window.location.href = `acertosdoaluno.html?provaId=${provaId}&nota=${Math.floor(Math.random() * 5) + 5}`;
    };
</script>
</body>
</html>
