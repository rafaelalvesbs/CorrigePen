<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Gabarito Final</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // SEUS DADOS CALIBRADOS
        const CONFIG = {
            startX: 315,
            startY: 340,
            gapX: 84,
            gapY: 69,
            size: 25, // Tamanho da área de leitura
            threshold: 40000 // Sensibilidade do preto (ajuste se necessário)
        };

        // GABARITO PARA CORREÇÃO (Altere aqui as respostas certas)
        const RESPOSTAS_CORRETAS = ['A', 'B', 'C', 'A', 'B', 'C', 'A', 'B', 'C', 'A'];

        function App() {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [alunoNotas, setAlunoNotas] = useState([]);
            const [currentScan, setCurrentScan] = useState([]);

            useEffect(() => {
                navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: 1280, height: 720 } 
                }).then(stream => videoRef.current.srcObject = stream);
                
                const timer = setInterval(scannerLogic, 150);
                return () => clearInterval(timer);
            }, []);

            const scannerLogic = () => {
                if (!videoRef.current || !canvasRef.current) return;
                const ctx = canvasRef.current.getContext('2d', { willReadFrequently: true });
                
                canvasRef.current.width = videoRef.current.videoWidth;
                canvasRef.current.height = videoRef.current.videoHeight;
                ctx.drawImage(videoRef.current, 0, 0);

                const detected = [];
                for (let q = 0; q < 10; q++) {
                    let marked = null;
                    let maxDark = 0;

                    ['A', 'B', 'C'].forEach((opt, i) => {
                        const x = CONFIG.startX + (i * CONFIG.gapX);
                        const y = CONFIG.startY + (q * CONFIG.gapY);
                        
                        const data = ctx.getImageData(x, y, CONFIG.size, CONFIG.size).data;
                        let dark = 0;
                        for (let p = 0; p < data.length; p += 4) {
                            dark += (255 - (data[p] + data[p+1] + data[p+2]) / 3);
                        }

                        if (dark > CONFIG.threshold && dark > maxDark) {
                            maxDark = dark;
                            marked = opt;
                        }
                        
                        // Desenha feedback na tela
                        ctx.strokeStyle = dark > CONFIG.threshold ? "#00ff00" : "#ff0000";
                        ctx.strokeRect(x, y, CONFIG.size, CONFIG.size);
                    });
                    detected.push(marked);
                }
                setCurrentScan(detected);
            };

            const salvarNota = () => {
                const acertos = currentScan.reduce((acc, res, i) => res === RESPOSTAS_CORRETAS[i] ? acc + 1 : acc, 0);
                const novaNota = {
                    id: alunoNotas.length + 1,
                    acertos,
                    nota: (acertos / 10 * 10).toFixed(1),
                    data: new Date().toLocaleTimeString()
                };
                setAlunoNotas([novaNota, ...alunoNotas]);
            };

            return (
                <div class="flex flex-col lg:flex-row h-screen">
                    {/* Lado Esquerdo: Câmera */}
                    <div class="relative flex-[2] bg-black">
                        <video ref={videoRef} autoPlay playsInline class="w-full h-full object-contain" />
                        <canvas ref={canvasRef} class="absolute top-0 left-0 w-full h-full object-contain pointer-events-none opacity-60" />
                        
                        <div class="absolute top-4 left-4 bg-black/60 p-2 rounded text-xs font-mono">
                            Status: Scanner Ativo (ABC - 10 Questões)
                        </div>
                    </div>

                    {/* Lado Direito: Resultados */}
                    <div class="flex-1 bg-slate-800 p-6 overflow-y-auto border-l border-slate-700">
                        <h2 class="text-xl font-bold mb-4 border-b border-slate-600 pb-2">Resultados</h2>
                        
                        <button 
                            onClick={salvarNota}
                            class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl mb-6 shadow-lg transition-all active:scale-95"
                        >
                            CONFIRMAR E SALVAR NOTA
                        </button>

                        <div class="space-y-3">
                            {alunoNotas.map(item => (
                                <div key={item.id} class="bg-slate-700 p-3 rounded-lg flex justify-between items-center border-l-4 border-green-500">
                                    <div>
                                        <p class="text-[10px] text-slate-400">Aluno #{item.id} - {item.data}</p>
                                        <p class="font-bold uppercase text-sm">{item.acertos} Acertos</p>
                                    </div>
                                    <div class="text-2xl font-black text-green-400">{item.nota}</div>
                                </div>
                            ))}
                        </div>

                        {alunoNotas.length === 0 && (
                            <div class="text-center text-slate-500 mt-10">
                                <p>Nenhum aluno escaneado ainda.</p>
                                <p class="text-xs">Aponte a câmera e clique no botão verde.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
