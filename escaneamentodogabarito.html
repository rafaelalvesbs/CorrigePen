<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Leitor OMR – 10 Questões</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: #111;
  color: white;
  font-family: Arial;
  text-align: center;
}
video, canvas {
  width: 100%;
  max-width: 420px;
}
button {
  margin: 10px;
  padding: 15px 30px;
  font-size: 18px;
  border-radius: 10px;
  background: #00ff00;
  border: none;
  font-weight: bold;
}
</style>
</head>

<body>

<h2>Leitor de Gabarito (OMR)</h2>

<video id="video" autoplay playsinline></video>
<button onclick="capturar()">CAPTURAR</button>
<canvas id="canvas"></canvas>

<audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const beep = document.getElementById("beep");

// Abrir câmera
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
}).then(stream => video.srcObject = stream);

// CONFIGURAÇÃO DO GABARITO
const QUESTOES = 10;
const ALTERNATIVAS = ["A", "B", "C"];

// posições RELATIVAS (percentual da imagem)
const baseX = [0.30, 0.50, 0.70]; // A B C
const baseY = 0.20;
const gapY = 0.06;
const box = 22;

function capturar() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0);
  analisar();
}

function analisar() {
  const img = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = img.data;
  let respostas = [];

  ctx.strokeStyle = "lime";
  ctx.lineWidth = 3;

  for (let q = 0; q < QUESTOES; q++) {
    let marcadas = [];

    for (let a = 0; a < 3; a++) {
      const x = Math.floor(canvas.width * baseX[a]);
      const y = Math.floor(canvas.height * (baseY + q * gapY));

      let pretos = 0;

      for (let dy = 0; dy < box; dy++) {
        for (let dx = 0; dx < box; dx++) {
          const px = ((y + dy) * canvas.width + (x + dx)) * 4;
          const gray = (data[px] + data[px+1] + data[px+2]) / 3;
          if (gray < 120) pretos++;
        }
      }

      if (pretos > 120) {
        marcadas.push(ALTERNATIVAS[a]);
        ctx.strokeRect(x, y, box, box);
      }
    }

    if (marcadas.length === 1) respostas.push(marcadas[0]);
    else if (marcadas.length > 1) respostas.push("ANULADA");
    else respostas.push("BRANCO");
  }

  beep.play();
  alert("Respostas detectadas:\n\n" + respostas.map((r,i)=>`${i+1}: ${r}`).join("\n"));
}
</script>

</body>
</html>
