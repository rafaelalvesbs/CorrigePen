<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>GradePen Simulator - PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; font-family: sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .scanner-container { position: relative; width: 1080px; height: 1920px; transform: scale(0.4); border: 10px solid #333; border-radius: 40px; overflow: hidden; background: #000; }
        #camera-feed { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; }
        .ui-overlay { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        .status-bar { position: absolute; top: 80px; width: 100%; text-align: center; color: #00ff00; font-size: 40px; font-weight: bold; text-shadow: 2px 2px 4px #000; }
        .corner { position: absolute; width: 80px; height: 80px; border: 8px solid #00ff00; }
        .top-left { top: 150px; left: 100px; border-right: 0; border-bottom: 0; }
        .top-right { top: 150px; right: 100px; border-left: 0; border-bottom: 0; }
        @keyframes bounce-short {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-short { animation: bounce-short 0.5s ease-in-out; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
const { useEffect, useRef, useState } = React;

const CONFIG = {
    startX: 377,
    startY: 351,
    gapX: 93,
    gapY: 76,
    size: 30,
    threshold: 35000
};

function App() {
    const videoRef = useRef(null);
    const canvasRef = useRef(null);
    const [scanAtual, setScanAtual] = useState([]);
    const [locked, setLocked] = useState(false);
    const [gabarito, setGabarito] = useState([]);
    const [notaFinal, setNotaFinal] = useState(0);

    useEffect(() => {
        const firebaseConfig = {
            apiKey: "AIzaSyCZ77ugK5a3pw-U0NH43F2x1bu09sS5pJg",
            authDomain: "correcao-de-provas-f315d.firebaseapp.com",
            projectId: "correcao-de-provas-f315d",
            databaseURL: "https://correcao-de-provas-f315d-default-rtdb.firebaseio.com",
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const params = new URLSearchParams(window.location.search);
        const provaId = params.get("provaId");

        if (provaId) {
            firebase.database().ref(`gabaritos/${provaId}`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const obj = snapshot.val();
                    const arr = Object.keys(obj)
                        .sort((a,b)=>Number(a)-Number(b))
                        .map(k => obj[k]);
                    setGabarito(arr);
                }
            });
        }

        navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
        }).then(stream => {
            videoRef.current.srcObject = stream;
        });
    }, []);

    const salvarNotaAutomatica = (leiturasFinais) => {
        if (gabarito.length === 0) return;
        setLocked(true);
        setTimeout(() => {
            let acertos = 0;
            leiturasFinais.forEach((resp, i) => {
                if (resp === gabarito[i]) acertos++;
            });
            const calculo = acertos * 2;
            setNotaFinal(calculo.toFixed(1));
            setScanAtual(leiturasFinais);
        }, 2000);
    };

    const processarFrame = () => {
        const video = videoRef.current;
        const canvas = canvasRef.current;
        if (!video || !canvas || video.readyState < 2) return;

        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        if (canvas.width !== 1080) {
            canvas.width = 1080;
            canvas.height = 1920;
        }

        ctx.drawImage(video, 0, 0, 1080, 1920);
        const leitura = [];
        let contagemDetectadas = 0;

        for (let q = 0; q < 10; q++) {
            let dadosOpcoes = [];
            ['A','B','C'].forEach((opt, i) => {
                const x = CONFIG.startX + i * CONFIG.gapX;
                const y = CONFIG.startY + q * CONFIG.gapY;
                const pixels = ctx.getImageData(x, y, CONFIG.size, CONFIG.size).data;
                let escuro = 0;
                for (let p = 0; p < pixels.length; p += 4) {
                    escuro += 255 - (pixels[p] + pixels[p+1] + pixels[p+2]) / 3;
                }
                
                // --- ALTERAÇÃO AQUI: Quadradinhos agora são Verdes ---
                ctx.strokeStyle = "#00ff00"; 
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, CONFIG.size, CONFIG.size);
                // ---------------------------------------------------
                
                dadosOpcoes.push({ opt, escuro, x, y });
            });

            dadosOpcoes.sort((a, b) => b.escuro - a.escuro);
            const maisEscura = dadosOpcoes[0];
            const segundaMaisEscura = dadosOpcoes[1];

            if (maisEscura.escuro > CONFIG.threshold && maisEscura.escuro > segundaMaisEscura.escuro * 1.5) {
                ctx.fillStyle = "rgba(0,255,0,0.6)";
                ctx.beginPath();
                ctx.arc(maisEscura.x + CONFIG.size/2, maisEscura.y + CONFIG.size/2, 25, 0, Math.PI*2);
                ctx.fill();
                
                ctx.fillStyle = "#00ff00";
                ctx.font = "bold 20px Arial";
                ctx.fillText(maisEscura.opt, maisEscura.x + 8, maisEscura.y + 22);
                
                leitura.push(maisEscura.opt);
                contagemDetectadas++;
            } else {
                leitura.push(null);
            }
        }
        
        setScanAtual(leitura);
        if (contagemDetectadas === 10 && !locked) {
            salvarNotaAutomatica(leitura);
        }
    };

    useEffect(() => {
        const timer = setInterval(() => {
            if (!locked) processarFrame();
        }, 150);
        return () => clearInterval(timer);
    }, [locked, gabarito]);

    return (
        <div className="scanner-container">
            <video ref={videoRef} autoPlay playsInline id="camera-feed" className={locked ? 'opacity-40' : 'opacity-60'}/>
            <canvas ref={canvasRef} />
            
            <div className="ui-overlay">
                <div className="status-bar">
                    {locked ? (notaFinal > 0 ? "CORREÇÃO CONCLUÍDA" : "PROCESSANDO...") : "ESCANEANDO GABARITO..."}
                </div>
                <div className="corner top-left"></div>
                <div className="corner top-right" style={{borderLeft: 0, borderBottom: 0, right: '100px', top: '150px'}}></div>
                
                {!locked && (
                    <div className="absolute top-[200px] left-1/2 -translate-x-1/2 bg-blue-600/80 px-8 py-4 rounded-full text-2xl font-bold uppercase tracking-widest border border-white/20 whitespace-nowrap">
                        {gabarito.length > 0 ? `Questões: ${scanAtual.filter(r => r !== null).length}/10` : "Carregando Gabarito..."}
                    </div>
                )}

                {locked && notaFinal > 0 && (
                    <div className="absolute inset-0 flex items-center justify-center p-6 bg-black/60 pointer-events-auto">
                        <div className="bg-slate-900 border-4 border-green-500 p-12 rounded-[60px] shadow-2xl text-center w-[600px] animate-bounce-short">
                            <p className="text-green-400 font-bold text-3xl uppercase tracking-widest mb-4">Nota Final</p>
                            <h2 className="text-[150px] font-black text-white mb-10">{notaFinal}</h2>
                            <button 
                                onClick={() => window.location.href = 'escaneamentodoqrcode.html'}
                                className="w-full bg-green-600 hover:bg-green-500 text-white font-black py-8 rounded-3xl text-4xl shadow-lg transition-transform active:scale-95"
                            >
                                PRÓXIMO ALUNO
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
