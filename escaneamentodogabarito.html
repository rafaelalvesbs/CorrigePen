<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner OMR Pro</title>
    <script src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; font-family: sans-serif; overflow: hidden; color: white; }
        
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1a1a1a; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
        }

        .container { position: relative; width: 100vw; height: 100vh; }
        video, #canvas-draw { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        .status-bar {
            position: absolute; top: 20px; left: 0; width: 100%; text-align: center;
            z-index: 10; padding: 15px; background: rgba(0,0,0,0.8);
        }

        #btn-capture {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            padding: 20px 50px; background: #00ff00; color: #000; border: none;
            border-radius: 50px; font-weight: 900; font-size: 18px; 
            display: none; z-index: 20; cursor: pointer;
        }

        /* Estilo do Popup */
        #result-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; z-index: 2000;
            flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        #result-image { max-width: 100%; max-height: 70%; border: 3px solid #00ff00; border-radius: 10px; }
        .close-btn { margin-top: 20px; padding: 15px 30px; background: white; color: black; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="loading-screen">
    <p>Carregando Visão Computacional...</p>
</div>

<div class="container">
    <div class="status-bar">
        <h3 id="info-text">BUSCANDO GABARITO...</h3>
    </div>
    <video id="video-feed" autoplay playsinline muted></video>
    <canvas id="canvas-draw"></canvas>
    <button id="btn-capture">CAPTURAR E CALCULAR</button>
</div>

<div id="result-popup">
    <h2>Resultado da Leitura</h2>
    <p id="count-text" style="margin: 10px 0; color: #00ff00; font-size: 20px;"></p>
    <img id="result-image" alt="Gabarito Processado">
    <div class="close-btn" onclick="closePopup()">TIRAR OUTRA FOTO</div>
</div>

<audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    const video = document.getElementById('video-feed');
    const canvas = document.getElementById('canvas-draw');
    const ctx = canvas.getContext('2d');
    const btnCapture = document.getElementById('btn-capture');
    const popup = document.getElementById('result-popup');
    const resultImg = document.getElementById('result-image');
    const infoText = document.getElementById('info-text');
    const countText = document.getElementById('count-text');
    const beep = document.getElementById('beep');

    let streamStarted = false;
    let markersFound = [];

    function onOpenCvReady() {
        document.getElementById('loading-screen').style.display = 'none';
        startCamera();
    }

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: 640, height: 480 }
            });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                video.play();
                streamStarted = true;
                processLoop();
            };
        } catch (e) { alert("Erro ao abrir câmera. Use HTTPS."); }
    }

    function processLoop() {
        if (!streamStarted) return;

        // Alocação de memória OpenCV
        let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        let gray = new cv.Mat();
        let thresh = new cv.Mat();
        let contours = new cv.MatVector();
        let hierarchy = new cv.Mat();
        const cap = new cv.VideoCapture(video);

        function frame() {
            try {
                cap.read(src);
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                cv.GaussianBlur(gray, gray, new cv.Size(5, 5), 0);
                cv.adaptiveThreshold(gray, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 11, 4);
                cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                canvas.width = video.clientWidth;
                canvas.height = video.clientHeight;
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                markersFound = [];
                const scaleX = canvas.width / video.videoWidth;
                const scaleY = canvas.height / video.videoHeight;

                for (let i = 0; i < contours.size(); i++) {
                    let cnt = contours.get(i);
                    let area = cv.contourArea(cnt);
                    let rect = cv.boundingRect(cnt);
                    let ratio = rect.width / rect.height;

                    if (area > 300 && area < 4000 && ratio > 0.7 && ratio < 1.3) {
                        markersFound.push(rect);
                        // Desenha verde em tempo real
                        ctx.beginPath();
                        ctx.arc((rect.x + rect.width/2)*scaleX, (rect.y + rect.height/2)*scaleY, (rect.width/2)*scaleX, 0, 2*Math.PI);
                        ctx.fillStyle = "rgba(0, 255, 0, 0.6)";
                        ctx.fill();
                    }
                }

                if (markersFound.length >= 3) {
                    infoText.innerText = markersFound.length + " MARCAS DETECTADAS";
                    btnCapture.style.display = "block";
                } else {
                    infoText.innerText = "BUSCANDO GABARITO...";
                    btnCapture.style.display = "none";
                }

                requestAnimationFrame(frame);
            } catch (e) { requestAnimationFrame(frame); }
        }
        frame();
    }

    btnCapture.onclick = () => {
        beep.play();
        
        // Criar uma imagem estática do canvas atual + o vídeo
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = video.videoWidth;
        tempCanvas.height = video.videoHeight;
        const tempCtx = tempCanvas.getContext('2d');
        
        // Desenha o frame atual do vídeo
        tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
        
        // Desenha as bolinhas verdes por cima para o popup
        markersFound.forEach(rect => {
            tempCtx.beginPath();
            tempCtx.arc(rect.x + rect.width/2, rect.y + rect.height/2, rect.width/2, 0, 2*Math.PI);
            tempCtx.fillStyle = "rgba(0, 255, 0, 0.7)";
            tempCtx.fill();
            tempCtx.strokeStyle = "white";
            tempCtx.lineWidth = 2;
            tempCtx.stroke();
        });

        // Mostra o Popup
        countText.innerText = "Foram identificadas " + markersFound.length + " marcações.";
        resultImg.src = tempCanvas.toDataURL('image/png');
        popup.style.display = "flex";
    };

    function closePopup() {
        popup.style.display = "none";
    }

    // Monitor do OpenCV
    const checkCV = setInterval(() => {
        if (typeof cv !== 'undefined' && cv.Mat) {
            clearInterval(checkCV);
            onOpenCvReady();
        }
    }, 500);
</script>

</body>
</html>
