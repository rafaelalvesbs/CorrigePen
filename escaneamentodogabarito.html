<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Integrado Firebase</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white overflow-hidden">
    <div id="root"></div>

    <script type="module" type="text/babel">
    // ... (Mantenha as importações do Firebase e CONFIG iguais ao anterior)

    function ScannerApp() {
        // ... (Mantenha os estados anteriores)
        const [showOverlay, setShowOverlay] = useState(false);

        const scannerLogic = () => {
            if (!videoRef.current || !canvasRef.current) return;
            const ctx = canvasRef.current.getContext('2d', { willReadFrequently: true });
            
            // Desenha o vídeo no canvas
            canvasRef.current.width = videoRef.current.videoWidth;
            canvasRef.current.height = videoRef.current.videoHeight;
            ctx.drawImage(videoRef.current, 0, 0);

            const detected = [];
            for (let q = 0; q < 10; q++) {
                let marked = null;
                let maxDark = 0;
                let coordsEleita = null;

                ['A', 'B', 'C'].forEach((opt, i) => {
                    const x = CONFIG.startX + (i * CONFIG.gapX);
                    const y = CONFIG.startY + (q * CONFIG.gapY);
                    
                    const data = ctx.getImageData(x, y, CONFIG.size, CONFIG.size).data;
                    let dark = 0;
                    for (let p = 0; p < data.length; p += 4) {
                        dark += (255 - (data[p] + data[p+1] + data[p+2]) / 3);
                    }

                    // Se estiver acima do limite e for a mais escura da linha
                    if (dark > CONFIG.threshold && dark > maxDark) {
                        maxDark = dark;
                        marked = opt;
                        coordsEleita = {x, y};
                    }

                    // Desenha o guia (quadradinho fino)
                    ctx.strokeStyle = "rgba(255,255,255,0.2)";
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, CONFIG.size, CONFIG.size);
                });

                // SE DETECTOU ALGO: Desenha um INDICADOR FORTE (Círculo Verde)
                if (marked && coordsEleita) {
                    ctx.fillStyle = "rgba(0, 255, 0, 0.5)"; // Verde transparente
                    ctx.beginPath();
                    ctx.arc(coordsEleita.x + CONFIG.size/2, coordsEleita.y + CONFIG.size/2, CONFIG.size/1.5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.strokeStyle = "#00FF00";
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
                detected.push(marked);
            }
            setCurrentScan(detected);
        };

        return (
            <div class="flex flex-col h-screen">
                <div class="relative flex-1 bg-black">
                    <video ref={videoRef} autoPlay playsInline class={`w-full h-full object-cover ${isLocked ? 'opacity-60' : ''}`} />
                    <canvas ref={canvasRef} class="absolute top-0 left-0 w-full h-full object-cover" />
                    
                    {/* LISTA LATERAL DE CONFERÊNCIA (Aparece só no Lock) */}
                    {isLocked && (
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 bg-black/80 p-3 rounded-xl border border-white/20 font-mono text-xs">
                            <h3 class="text-green-400 font-bold mb-2 underline">LIDO:</h3>
                            {currentScan.map((res, i) => (
                                <div key={i} class="flex justify-between gap-4">
                                    <span class="text-gray-400">{i+1}:</span>
                                    <span class={res ? "text-white font-bold" : "text-red-500"}>{res || "?"}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* ... (Botões de Voltar e Confirmar iguais) */}
            </div>
        );
    }
</script>
</body>
</html>
