<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>GradePen Simulator - Modo Foto</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        body { margin: 0; background: #1a1a1a; font-family: sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .scanner-container { position: relative; width: 1080px; height: 1920px; transform: scale(0.4); border: 10px solid #333; border-radius: 40px; overflow: hidden; background: #000; }
        #camera-feed { position: absolute; width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .ui-overlay { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .status-bar { position: absolute; top: 80px; width: 100%; text-align: center; color: #00ff00; font-size: 40px; font-weight: bold; text-shadow: 2px 2px 4px #000; }
        .corner { position: absolute; width: 80px; height: 80px; border: 8px solid #00ff00; }
        .top-left { top: 150px; left: 100px; border-right: 0; border-bottom: 0; }
        .top-right { top: 150px; right: 100px; border-left: 0; border-bottom: 0; }
        @keyframes bounce-short {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-short { animation: bounce-short 0.5s ease-in-out; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
const { useEffect, useRef, useState } = React;

const CONFIG = {
    startX: 377,
    startY: 351,
    gapX: 93,
    gapY: 76,
    size: 30,
    threshold: 35000
};

function App() {
    const videoRef = useRef(null);
    const canvasRef = useRef(null);
    const [locked, setLocked] = useState(false);
    const [gabarito, setGabarito] = useState([]);
    const [notaFinal, setNotaFinal] = useState(0);

    useEffect(() => {
        // Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCZ77ugK5a3pw-U0NH43F2x1bu09sS5pJg",
            authDomain: "correcao-de-provas-f315d.firebaseapp.com",
            projectId: "correcao-de-provas-f315d",
            databaseURL: "https://correcao-de-provas-f315d-default-rtdb.firebaseio.com",
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const params = new URLSearchParams(window.location.search);
        const provaId = params.get("provaId");

        if (provaId) {
            firebase.database().ref(`gabaritos/${provaId}`).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const obj = snapshot.val();
                    const arr = Object.keys(obj)
                        .sort((a,b)=>Number(a)-Number(b))
                        .map(k => obj[k]);
                    setGabarito(arr);
                }
            });
        }

        // Iniciar Câmera
        navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment", width: { ideal: 1080 }, height: { ideal: 1920 } }
        }).then(stream => {
            if (videoRef.current) videoRef.current.srcObject = stream;
        }).catch(err => alert("Erro ao acessar câmera: " + err));
    }, []);

    const tirarFotoECorrigir = () => {
        const video = videoRef.current;
        const canvas = canvasRef.current;
        if (!video || !canvas) return;

        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        canvas.width = 1080;
        canvas.height = 1920;

        // Tira a foto
        ctx.drawImage(video, 0, 0, 1080, 1920);
        setLocked(true);

        const leitura = [];
        let acertos = 0;

        // Processa a imagem capturada
        for (let q = 0; q < 10; q++) {
            let dadosOpcoes = [];
            ['A','B','C'].forEach((opt, i) => {
                const x = CONFIG.startX + i * CONFIG.gapX;
                const y = CONFIG.startY + q * CONFIG.gapY;
                
                const pixels = ctx.getImageData(x, y, CONFIG.size, CONFIG.size).data;
                let escuro = 0;
                for (let p = 0; p < pixels.length; p += 4) {
                    escuro += 255 - (pixels[p] + pixels[p+1] + pixels[p+2]) / 3;
                }
                dadosOpcoes.push({ opt, escuro, x, y });
            });

            dadosOpcoes.sort((a, b) => b.escuro - a.escuro);
            const maisEscura = dadosOpcoes[0];
            const segunda = dadosOpcoes[1];

            if (maisEscura.escuro > CONFIG.threshold && maisEscura.escuro > segunda.escuro * 1.5) {
                // Desenha feedback visual no canvas
                ctx.fillStyle = "rgba(0,255,0,0.6)";
                ctx.beginPath();
                ctx.arc(maisEscura.x + CONFIG.size/2, maisEscura.y + CONFIG.size/2, 25, 0, Math.PI*2);
                ctx.fill();
                
                leitura.push(maisEscura.opt);
                if (maisEscura.opt === gabarito[q]) acertos++;
            } else {
                leitura.push(null);
            }
        }

        // Define a nota (cada acerto vale 1.0 se for de 0 a 10, ou ajuste conforme seu cálculo)
        setTimeout(() => {
            setNotaFinal((acertos * 1.0).toFixed(1)); 
        }, 500);
    };

    return (
        <div className="scanner-container">
            <video ref={videoRef} autoPlay playsInline id="camera-feed" className={locked ? 'opacity-30' : 'opacity-100'}/>
            <canvas ref={canvasRef} style={{ display: locked ? 'block' : 'none' }} />
            
            <div className="ui-overlay">
                <div className="status-bar">
                    {locked ? "FOTO CAPTURADA" : "MODO FOTO: ALINHE E DISPARE"}
                </div>
                
                <div className="corner top-left"></div>
                <div className="corner top-right"></div>
                
                {!locked && (
                    <div className="absolute bottom-[200px] left-1/2 -translate-x-1/2 pointer-events-auto">
                        <button 
                            onClick={tirarFotoECorrigir}
                            className="w-40 h-40 bg-white rounded-full border-[15px] border-green-500 shadow-2xl active:scale-90 transition-transform"
                        >
                        </button>
                    </div>
                )}

                {locked && (
                    <div className="absolute inset-0 flex items-center justify-center p-6 bg-black/40 pointer-events-auto">
                        <div className="bg-slate-900 border-4 border-green-500 p-12 rounded-[60px] text-center w-[700px] animate-bounce-short">
                            <p className="text-green-400 font-bold text-4xl mb-4">NOTA DO ALUNO</p>
                            <h2 className="text-[200px] font-black text-white mb-10">{notaFinal}</h2>
                            <button 
                                onClick={() => window.location.reload()}
                                className="w-full bg-green-600 text-white font-black py-10 rounded-3xl text-5xl active:scale-95"
                            >
                                PRÓXIMO
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
